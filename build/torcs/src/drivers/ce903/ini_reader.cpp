#include <string>
#include <iostream>
#include <algorithm>
#include <fstream>
#include <vector>
using namespace std;

// makes all the cases lower case in a string
string makelower(const string & s) {
    string str = s;
    for( string::iterator i = str.begin(); i != str.end(); ++i)
        if (tolower(*i) != (int)*i)
            *i = (char)tolower(*i);
    return str;
}

// removes spaces from string
string clear_spaces(string &s) {
	string out;
	
	for (int i = 0; i < s.length(); i++){
		if (s[i] != ' '){
			out = out + s[i];
		}
	}
	return out;
}

// removes any information behind ';' from a string
string clear_comments_old(string &s){
	string out;
	
	
	string _s = s;
	_s[_s.length()-1] = ';';
	
	for (int i = 0; i < _s.length(); i++){
		if (_s[i] != ';'){
			out = out + _s[i];
		} else {
			i = _s.length()+1;
		}
	}
	return out;
}

string clear_comments(string &s){
	
	vector<char> arr;
	bool found = false;
	
	for (int i = 0; i < s.length(); i++){
		if (!found){			
			if (s[i] != ';'){
				arr.push_back(s[i]);
			} else {
				found = true;
			}
		}
	}
	
	string out(arr.begin(), arr.end());
	
	return out;
}


// removes comments, clears spaces and makes lowercase 
string clean(string &s){
	s = clear_comments(s);
	s = clear_spaces(s);
	s = makelower(s);
	return s;
}

//splits a string using '=' as delimiter into a parameter name and value
void split(string s, string &a, string &b){
	bool found = false;
	bool just_found = false;
	
	for (int i = 0; i < s.length(); i++){
		if (s[i] == '='){
			found = true;
			just_found = true;
		}
		
		if (!found) {
			a = a + s[i];
		} else {
			if (!just_found) {
				b = b + s[i];
			} else {
				just_found = false;
			}
		}
	}
	
}


// removes [ and ] from string
string rmsquare(string &s) {
	string out;
	
	for (int i = 0; i < s.length(); i++){
		if (s[i] != '[' && s[i] != ']'){
			out = out + s[i];
		} else if (s[i] == ']'){
			return out;
		}
	}
	
	return out;
}

// reads a ini file and returns the information within the file as an array
vector <vector<string>> readConfigFile(string & inifile){
	ifstream file( inifile.c_str() );
    if (!file){
		cout << "Config file not found" << endl;
		exit(-1);
	}
	
	vector <string> types;
	vector <string> variables;
	vector <string> values;
	
	string s;
	string type;

	while (getline(file, s)) {
		
		bool found_open  = false;
		bool found_close  = false;
		for (int i = 0; i < s.length(); i++){
			if (s[i] == '['){
				found_open = true;
			} else if (s[i] == ']'){
				found_close = true;
			}
		}
		
		if (found_open && found_close){
			type = clean(s);
			type = rmsquare(type);
			
		} else if (s == "\r"){
			;
		} else if (s == "\n"){
			;
		} else if (s == "\r\n"){
			;
		} else if (s == "\n\r"){
			;
		} else if (s == " "){
			;
		} else if (s == ""){
			;
		} else if (s.size() == 0){
			;
		} else {
			s = clean(s);
			string variable = "";
			string value = "";
			
			split(s, variable, value);
			
			types.push_back(type);
			variables.push_back(variable);
			values.push_back(value);
			
		}
    }
    file.close();
	vector <vector<string>> vectors;
	vectors.push_back(types);
	vectors.push_back(variables);
	vectors.push_back(values);
	return vectors;
}

// searches the array generated by readConfigFile for the parameter needed. 
void find_var(string inifile, string type, string variable, string &value){
	bool found = false;
	
	//type = '[' + type + ']';
	
	vector <vector<string>> vectors;
	vectors = readConfigFile(inifile);
	
	vector <string> types = vectors[0];
	vector <string> variables = vectors[1];
	vector <string> values = vectors[2];
	
	
	for (int i = 0; i < types.size(); i++){
		if (types[i].compare(type) == 0){
			if (variables[i].compare(variable) == 0){
				value = values[i];
				found = true;
			}
		}
	}
	
	if (!found){
		cout << "could not find the " << type << ", " << variable << " parameter from " << inifile << endl;
		cout << "ini trace below" << endl;
		for (int i = 0; i < types.size(); i++){
			cout << "types[" << i << "] = " << types[i] <<  " | variables[" << i << "] = " << variables[i] <<  " | values[" << i << "] = " << values[i] << endl; 	
		}
		exit(-1);
	}
	
}